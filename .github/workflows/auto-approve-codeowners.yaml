name: Auto-approve if code owner
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-and-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Check if author is code owner
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const codeowners = fs.readFileSync('.github/CODEOWNERS', 'utf8');
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const author = context.payload.pull_request.user.login;
            console.log(`PR Author: ${author}`);
            console.log(`Changed files: ${files.map(f => f.filename).join(', ')}`);
            
            // Parse CODEOWNERS and check if author owns all changed files
            const lines = codeowners.split('\n');
            let authorOwnsAll = true;
            
            for (const file of files) {
              let fileOwned = false;
              console.log(`Checking file: ${file.filename}`);
              
              for (const line of lines) {
                if (line.trim().startsWith('#') || line.trim() === '') continue;
                console.log(`${line}`);
                if (line.includes(file.filename) && line.includes(`@${author}`)) {
                  fileOwned = true;
                  console.log(`  ✓ Owned by author in line: ${line}`);
                  break;
                }
              }
              
              if (!fileOwned) {
                console.log(`  ✗ NOT owned by author`);
                authorOwnsAll = false;
                break;
              }
            }
            
            console.log(`Author owns all files: ${authorOwnsAll}`);
            core.setOutput('should_approve', authorOwnsAll);
            return authorOwnsAll;
            
      - name: Auto-approve PR
        if: steps.check.outputs.should_approve == 'true'
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.AUTO_APPROVE_TOKEN }}
          approve-message: 'Auto-approved as the PR author is the code owner of all changed files.'

