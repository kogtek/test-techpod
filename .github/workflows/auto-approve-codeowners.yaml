name: Auto-approve if code owner
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-and-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Check if author is code owner
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const codeowners = fs.readFileSync('.github/CODEOWNERS', 'utf8');
            
            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const author = context.payload.pull_request.user.login;
            
            // Parse CODEOWNERS and check if author owns all changed files
            // (simplified logic - you'd need proper CODEOWNERS parsing)
            const lines = codeowners.split('\n');
            let authorOwnsAll = true;
            
            for (const file of files) {
              let fileOwned = false;
              for (const line of lines) {
                if (line.includes(file.filename) && line.includes(`@${author}`)) {
                  fileOwned = true;
                  break;
                }
              }
              if (!fileOwned) {
                authorOwnsAll = false;
                break;
              }
            }
            
            return authorOwnsAll;
            
      - name: Auto-approve PR
        if: steps.check.outputs.result == 'true'
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.AUTO_APPROVE_TOKEN }}
          approve-message: 'Auto-approved as the author is the code owner for all changed files.'
